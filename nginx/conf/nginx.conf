user www-data;
pid /run/nginx.pid;
worker_processes auto;

events {
  worker_connections  2048;
  multi_accept on;
  use epoll;      
}

http {
        charset utf-8;
        include /etc/nginx/mime.types;
        default_type application/octet-stream;

        access_log off;
        error_log /var/log/nginx/error.log crit;

        keepalive_timeout  30;
        keepalive_requests 100;

        client_max_body_size  10m;
        client_body_timeout 10;
        reset_timedout_connection on;
        send_timeout 2;
        sendfile on;
        tcp_nodelay on;
        tcp_nopush on;

        gzip on;
        gzip_disable "msie6";
        gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript application/javascript;

        open_file_cache max=200000 inactive=20s;
        open_file_cache_valid 30s;
        open_file_cache_min_uses 2;
        open_file_cache_errors on;

        server {
            listen 80;
            listen [::]:80;
            
            server_name frontend;    
            root /var/www-frontend/;
            
            location / {
                index index.html;
            }

            location ~ \.css {
                add_header  Content-Type    text/css;
            }

            location ~ \.js {
                add_header  Content-Type    application/x-javascript;
            }
            
            location ~* \.(js|css|gif|jpg|png)$ {
                expires 30d;
            }
            
            location ~ /\.ht {
                deny all;
            }

            access_log /var/log/nginx/access.log;
            error_log /var/log/nginx/error.log;
        }

        server {
                listen 8080;
                listen [::]:8080;

                server_name api;
                root        /var/www-backend/public;
                index       index.php;

                #add_header 'Access-Control-Allow-Origin' '*';
                #add_header 'Access-Control-Allow-Credentials' 'true';
                #add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, PATCH, DELETE, OPTIONS';
                #add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Mx-ReqToken,X-Requested-With';

               #if ($request_method = 'OPTIONS') {	
               #   return 204;
               #}

               location ~* \.(js|css|gif|jpg|png)$ {
                   expires 30d;
               }


               location / {
                   # Redirect everything that isn't a real file to index.php
                   try_files $uri $uri/ /index.php$is_args$args;
               }

               location ~ \.php$ {
                   #include fastcgi_params;
                   #fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                   #fastcgi_pass   phpfpm:9000;
                   ##fastcgi_pass unix:/var/run/php5-fpm.sock;
                   #try_files $uri =404;
                   #fastcgi_read_timeout 600;

                   try_files $uri /index.php =404;
                   fastcgi_pass phpfpm:9000;
                   fastcgi_index index.php;
                   fastcgi_buffers 16 16k;
                   fastcgi_buffer_size 32k;
                   fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                   fastcgi_read_timeout 600;
                   include fastcgi_params;
                   add_header 'Access-Control-Allow-Origin' '*';
                   add_header 'Access-Control-Allow-Credentials' 'true';
                   add_header 'Access-Control-Allow-Methods' 'GET, POST, PUT, DELETE, OPTIONS';
                   add_header 'Access-Control-Allow-Headers' 'Accept,Authorization,Cache-Control,Content-Type,DNT,If-Modified-Since,Keep-Alive,Origin,User-Agent,X-Requested-With';
                   if ($request_method = 'OPTIONS') {	
                        return 204;
                   }     
               }

               location ~ /\.(ht|svn|git) {
                   deny all;
               }

               access_log  /var/log/nginx/api-access.log;
               error_log   /var/log/nginx/api-error.log;       
        }
}

